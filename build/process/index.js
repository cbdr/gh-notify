'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = processPRs;

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _retrieve = require('../retrieve');

var _retrieve2 = _interopRequireDefault(_retrieve);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var oneDay = 24 * 60 * 60 * 1000;

function processPRs() {
  return (0, _retrieve2.default)({ repo: 'cbax-' }).then(function (repos) {
    return _lodash2.default.filter(repos, function (r) {
      return r.pullRequests.length > 0;
    });
  }).then(function (repos) {
    return _lodash2.default.map(repos, mapPRs);
  }).tap(console.log).then(function (PRs) {
    return _lodash2.default.flatten(PRs);
  }).tap(console.log);
}

function mapPRs(repo) {
  return _lodash2.default.map(repo.pullRequests, function (PR) {

    PR.repo = repo.name;
    PR.owner = PR.owner.login;
    PR.link = PR.url;
    PR.timeOpen = (new Date() - new Date(PR.created)) / oneDay;
    PR.workingDays = getWorkingDaysSince(PR.created);
    PR.timeSinceLastModified = (new Date() - new Date(PR.updated)) / oneDay;

    PR.assignees = _lodash2.default.map(PR.assignees, function (assignee) {
      return assignee.login;
    });
    PR.level = getLevel(PR);

    PR = prune(PR);

    return PR;
  });
}

function getWorkingDaysSince(date) {
  var start = new Date(date);
  var end = new Date();

  var days = 0;
  var currentDay = start;

  while (currentDay < end) {
    currentDay = new Date(currentDay);
    if (currentDay.getDay() != 0 && currentDay.getDay() != 6) {
      days++;
    }
    currentDay = new Date(currentDay.getTime() + oneDay);
  }

  return days;
}

function getLevel(PR) {
  PR.comments = _lodash2.default.filter(PR.comments, function (comment) {
    if (comment.user.login !== PR.owner) {
      return true;
    }
  });
  var hasLabels = PR.labels.length > 0;
  var noComments = PR.comments.length === 0;
  if ((PR.assignees.length === 0 || PR.workingDays >= 4) && !hasLabels) {
    return 10; //red: no assignees or stale
  }
  if ((PR.workingDays >= 2 || PR.workingDays > 1 && noComments) && !hasLabels) {
    return 5; //yellow going stale (outstanding > 2 days or no comments from assignees yet && older than 16 hours)
  }
  return 0; //green
}

function prune(PR) {
  var fieldsToRemove = ['id', 'number', 'url', 'comments', 'created', 'updated', 'timeOpen', 'timeSinceLastModified'];

  return _lodash2.default.omit(PR, fieldsToRemove);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9wcm9jZXNzL2luZGV4LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O2tCQU93QixVOztBQVB4Qjs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7Ozs7O0FBRUEsSUFBSSxTQUFTLEtBQUssRUFBTCxHQUFVLEVBQVYsR0FBZSxJQUE1Qjs7QUFFZSxTQUFTLFVBQVQsR0FBc0I7QUFDbkMsU0FBTyx3QkFBZ0IsRUFBRSxNQUFNLE9BQVIsRUFBaEIsRUFDSixJQURJLENBQ0MsVUFBQyxLQUFEO0FBQUEsV0FBVyxpQkFBRSxNQUFGLENBQVMsS0FBVCxFQUFnQixVQUFDLENBQUQ7QUFBQSxhQUFPLEVBQUUsWUFBRixDQUFlLE1BQWYsR0FBd0IsQ0FBL0I7QUFBQSxLQUFoQixDQUFYO0FBQUEsR0FERCxFQUVKLElBRkksQ0FFQyxVQUFDLEtBQUQ7QUFBQSxXQUFXLGlCQUFFLEdBQUYsQ0FBTSxLQUFOLEVBQWEsTUFBYixDQUFYO0FBQUEsR0FGRCxFQUdKLEdBSEksQ0FHQSxRQUFRLEdBSFIsRUFJSixJQUpJLENBSUMsVUFBQyxHQUFEO0FBQUEsV0FBUyxpQkFBRSxPQUFGLENBQVUsR0FBVixDQUFUO0FBQUEsR0FKRCxFQUtKLEdBTEksQ0FLQSxRQUFRLEdBTFIsQ0FBUDtBQU1EOztBQUVELFNBQVMsTUFBVCxDQUFnQixJQUFoQixFQUFzQjtBQUNwQixTQUFPLGlCQUFFLEdBQUYsQ0FBTSxLQUFLLFlBQVgsRUFBeUIsVUFBQyxFQUFELEVBQVE7O0FBRXRDLE9BQUcsSUFBSCxHQUFVLEtBQUssSUFBZjtBQUNBLE9BQUcsS0FBSCxHQUFXLEdBQUcsS0FBSCxDQUFTLEtBQXBCO0FBQ0EsT0FBRyxJQUFILEdBQVUsR0FBRyxHQUFiO0FBQ0EsT0FBRyxRQUFILEdBQWMsQ0FBQyxJQUFJLElBQUosS0FBYSxJQUFJLElBQUosQ0FBUyxHQUFHLE9BQVosQ0FBZCxJQUFzQyxNQUFwRDtBQUNBLE9BQUcsV0FBSCxHQUFpQixvQkFBb0IsR0FBRyxPQUF2QixDQUFqQjtBQUNBLE9BQUcscUJBQUgsR0FBMkIsQ0FBQyxJQUFJLElBQUosS0FBYSxJQUFJLElBQUosQ0FBUyxHQUFHLE9BQVosQ0FBZCxJQUFzQyxNQUFqRTs7QUFFQSxPQUFHLFNBQUgsR0FBZSxpQkFBRSxHQUFGLENBQU0sR0FBRyxTQUFULEVBQW9CLFVBQUMsUUFBRDtBQUFBLGFBQWMsU0FBUyxLQUF2QjtBQUFBLEtBQXBCLENBQWY7QUFDQSxPQUFHLEtBQUgsR0FBVyxTQUFTLEVBQVQsQ0FBWDs7QUFFQSxTQUFLLE1BQU0sRUFBTixDQUFMOztBQUVBLFdBQU8sRUFBUDtBQUNELEdBZk0sQ0FBUDtBQWdCRDs7QUFFRCxTQUFTLG1CQUFULENBQTZCLElBQTdCLEVBQW1DO0FBQ2pDLE1BQU0sUUFBUSxJQUFJLElBQUosQ0FBUyxJQUFULENBQWQ7QUFDQSxNQUFNLE1BQU0sSUFBSSxJQUFKLEVBQVo7O0FBRUEsTUFBSSxPQUFPLENBQVg7QUFDQSxNQUFJLGFBQWEsS0FBakI7O0FBRUEsU0FBTSxhQUFhLEdBQW5CLEVBQXdCO0FBQ3RCLGlCQUFhLElBQUksSUFBSixDQUFTLFVBQVQsQ0FBYjtBQUNBLFFBQUcsV0FBVyxNQUFYLE1BQXVCLENBQXZCLElBQTRCLFdBQVcsTUFBWCxNQUF1QixDQUF0RCxFQUF5RDtBQUN2RDtBQUNEO0FBQ0QsaUJBQWEsSUFBSSxJQUFKLENBQVMsV0FBVyxPQUFYLEtBQXVCLE1BQWhDLENBQWI7QUFDRDs7QUFFRCxTQUFPLElBQVA7QUFDRDs7QUFFRCxTQUFTLFFBQVQsQ0FBa0IsRUFBbEIsRUFBc0I7QUFDcEIsS0FBRyxRQUFILEdBQWMsaUJBQUUsTUFBRixDQUFTLEdBQUcsUUFBWixFQUFzQixVQUFDLE9BQUQsRUFBYTtBQUMvQyxRQUFHLFFBQVEsSUFBUixDQUFhLEtBQWIsS0FBdUIsR0FBRyxLQUE3QixFQUFvQztBQUNsQyxhQUFPLElBQVA7QUFDRDtBQUNGLEdBSmEsQ0FBZDtBQUtBLE1BQUksWUFBWSxHQUFHLE1BQUgsQ0FBVSxNQUFWLEdBQW1CLENBQW5DO0FBQ0EsTUFBSSxhQUFhLEdBQUcsUUFBSCxDQUFZLE1BQVosS0FBdUIsQ0FBeEM7QUFDQSxNQUFHLENBQUMsR0FBRyxTQUFILENBQWEsTUFBYixLQUF3QixDQUF4QixJQUE2QixHQUFHLFdBQUgsSUFBa0IsQ0FBaEQsS0FBc0QsQ0FBQyxTQUExRCxFQUFxRTtBQUNuRSxXQUFPLEVBQVAsQztBQUNEO0FBQ0QsTUFBRyxDQUFDLEdBQUcsV0FBSCxJQUFrQixDQUFsQixJQUF3QixHQUFHLFdBQUgsR0FBaUIsQ0FBakIsSUFBc0IsVUFBL0MsS0FBK0QsQ0FBQyxTQUFuRSxFQUE4RTtBQUM1RSxXQUFPLENBQVAsQztBQUNEO0FBQ0QsU0FBTyxDQUFQLEM7QUFDRDs7QUFFRCxTQUFTLEtBQVQsQ0FBZSxFQUFmLEVBQW1CO0FBQ2pCLE1BQUksaUJBQWlCLENBQ25CLElBRG1CLEVBRW5CLFFBRm1CLEVBR25CLEtBSG1CLEVBSW5CLFVBSm1CLEVBS25CLFNBTG1CLEVBTW5CLFNBTm1CLEVBT25CLFVBUG1CLEVBUW5CLHVCQVJtQixDQUFyQjs7QUFXQSxTQUFPLGlCQUFFLElBQUYsQ0FBTyxFQUFQLEVBQVcsY0FBWCxDQUFQO0FBQ0QiLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IFByb21pc2UgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IGZzIGZyb20gJ2ZzJztcbmltcG9ydCBnZXRSZXBvc2l0b3JpZXMgZnJvbSAnLi4vcmV0cmlldmUnO1xuXG5sZXQgb25lRGF5ID0gMjQgKiA2MCAqIDYwICogMTAwMDtcblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gcHJvY2Vzc1BScygpIHtcbiAgcmV0dXJuIGdldFJlcG9zaXRvcmllcyh7IHJlcG86ICdjYmF4LScgfSlcbiAgICAudGhlbigocmVwb3MpID0+IF8uZmlsdGVyKHJlcG9zLCAocikgPT4gci5wdWxsUmVxdWVzdHMubGVuZ3RoID4gMCApKVxuICAgIC50aGVuKChyZXBvcykgPT4gXy5tYXAocmVwb3MsIG1hcFBScykpXG4gICAgLnRhcChjb25zb2xlLmxvZylcbiAgICAudGhlbigoUFJzKSA9PiBfLmZsYXR0ZW4oUFJzKSlcbiAgICAudGFwKGNvbnNvbGUubG9nKTtcbn1cblxuZnVuY3Rpb24gbWFwUFJzKHJlcG8pIHtcbiAgcmV0dXJuIF8ubWFwKHJlcG8ucHVsbFJlcXVlc3RzLCAoUFIpID0+IHtcblxuICAgIFBSLnJlcG8gPSByZXBvLm5hbWU7XG4gICAgUFIub3duZXIgPSBQUi5vd25lci5sb2dpbjtcbiAgICBQUi5saW5rID0gUFIudXJsO1xuICAgIFBSLnRpbWVPcGVuID0gKG5ldyBEYXRlKCkgLSBuZXcgRGF0ZShQUi5jcmVhdGVkKSkgLyBvbmVEYXk7XG4gICAgUFIud29ya2luZ0RheXMgPSBnZXRXb3JraW5nRGF5c1NpbmNlKFBSLmNyZWF0ZWQpO1xuICAgIFBSLnRpbWVTaW5jZUxhc3RNb2RpZmllZCA9IChuZXcgRGF0ZSgpIC0gbmV3IERhdGUoUFIudXBkYXRlZCkpIC8gb25lRGF5O1xuXG4gICAgUFIuYXNzaWduZWVzID0gXy5tYXAoUFIuYXNzaWduZWVzLCAoYXNzaWduZWUpID0+IGFzc2lnbmVlLmxvZ2luKTtcbiAgICBQUi5sZXZlbCA9IGdldExldmVsKFBSKTtcblxuICAgIFBSID0gcHJ1bmUoUFIpO1xuXG4gICAgcmV0dXJuIFBSO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gZ2V0V29ya2luZ0RheXNTaW5jZShkYXRlKSB7XG4gIGNvbnN0IHN0YXJ0ID0gbmV3IERhdGUoZGF0ZSk7XG4gIGNvbnN0IGVuZCA9IG5ldyBEYXRlKCk7XG5cbiAgbGV0IGRheXMgPSAwO1xuICBsZXQgY3VycmVudERheSA9IHN0YXJ0O1xuXG4gIHdoaWxlKGN1cnJlbnREYXkgPCBlbmQpIHtcbiAgICBjdXJyZW50RGF5ID0gbmV3IERhdGUoY3VycmVudERheSk7XG4gICAgaWYoY3VycmVudERheS5nZXREYXkoKSAhPSAwICYmIGN1cnJlbnREYXkuZ2V0RGF5KCkgIT0gNikge1xuICAgICAgZGF5cysrO1xuICAgIH1cbiAgICBjdXJyZW50RGF5ID0gbmV3IERhdGUoY3VycmVudERheS5nZXRUaW1lKCkgKyBvbmVEYXkpO1xuICB9XG5cbiAgcmV0dXJuIGRheXM7XG59XG5cbmZ1bmN0aW9uIGdldExldmVsKFBSKSB7XG4gIFBSLmNvbW1lbnRzID0gXy5maWx0ZXIoUFIuY29tbWVudHMsIChjb21tZW50KSA9PiB7XG4gICAgaWYoY29tbWVudC51c2VyLmxvZ2luICE9PSBQUi5vd25lcikge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICB9KTtcbiAgbGV0IGhhc0xhYmVscyA9IFBSLmxhYmVscy5sZW5ndGggPiAwO1xuICBsZXQgbm9Db21tZW50cyA9IFBSLmNvbW1lbnRzLmxlbmd0aCA9PT0gMDtcbiAgaWYoKFBSLmFzc2lnbmVlcy5sZW5ndGggPT09IDAgfHwgUFIud29ya2luZ0RheXMgPj0gNCkgJiYgIWhhc0xhYmVscykge1xuICAgIHJldHVybiAxMDsgLy9yZWQ6IG5vIGFzc2lnbmVlcyBvciBzdGFsZVxuICB9XG4gIGlmKChQUi53b3JraW5nRGF5cyA+PSAyIHx8IChQUi53b3JraW5nRGF5cyA+IDEgJiYgbm9Db21tZW50cykpICYmICFoYXNMYWJlbHMpIHtcbiAgICByZXR1cm4gNTsgLy95ZWxsb3cgZ29pbmcgc3RhbGUgKG91dHN0YW5kaW5nID4gMiBkYXlzIG9yIG5vIGNvbW1lbnRzIGZyb20gYXNzaWduZWVzIHlldCAmJiBvbGRlciB0aGFuIDE2IGhvdXJzKVxuICB9XG4gIHJldHVybiAwOyAvL2dyZWVuXG59XG5cbmZ1bmN0aW9uIHBydW5lKFBSKSB7XG4gIGxldCBmaWVsZHNUb1JlbW92ZSA9IFtcbiAgICAnaWQnLFxuICAgICdudW1iZXInLFxuICAgICd1cmwnLFxuICAgICdjb21tZW50cycsXG4gICAgJ2NyZWF0ZWQnLFxuICAgICd1cGRhdGVkJyxcbiAgICAndGltZU9wZW4nLFxuICAgICd0aW1lU2luY2VMYXN0TW9kaWZpZWQnXG4gIF07XG5cbiAgcmV0dXJuIF8ub21pdChQUiwgZmllbGRzVG9SZW1vdmUpO1xufSJdfQ==